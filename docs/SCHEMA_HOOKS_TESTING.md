# Schema Hooks Testing Guide

Este documento descreve como testar e validar o funcionamento dos hooks implementados para processamento de schemas.

## Hooks Implementados

### 1. Content Hook: `content:file:beforeParse`
- **Quando executa**: Durante o parse de arquivos pelo Nuxt Content
- **Arquivos processados**: `*-schema.yaml`
- **FunÃ§Ã£o**: Atualiza URLs `$id` baseado no ambiente atual

### 2. Build Hook: `build:before`
- **Quando executa**: Antes do build do Nuxt iniciar
- **FunÃ§Ã£o**: ValidaÃ§Ã£o de schemas + processamento em debug mode
- **ConfiguraÃ§Ã£o**: `DEBUG_SCHEMAS=true` ou `FORCE_SCHEMA_REBUILD=true`

### 3. Nitro Hook: `nitro:build:before`
- **Quando executa**: Antes do build do Nitro
- **FunÃ§Ã£o**: ValidaÃ§Ã£o final para produÃ§Ã£o
- **Comportamento**: Falha build se schemas invÃ¡lidos em produÃ§Ã£o

### 4. Build Hook: `build:done`
- **Quando executa**: ApÃ³s build completado
- **FunÃ§Ã£o**: Log de confirmaÃ§Ã£o

## Comandos de Teste

### Scripts NPM DisponÃ­veis

```bash
# Processamento automÃ¡tico antes do build
pnpm build
pnpm generate

# Processamento manual
pnpm schemas:process

# ValidaÃ§Ã£o apenas
pnpm schemas:validate

# ForÃ§a rebuild de todos os schemas
pnpm schemas:force-rebuild
```

### VariÃ¡veis de Ambiente para Teste

```bash
# Desenvolvimento (padrÃ£o)
NODE_ENV=development
SITE_URL=http://localhost:3000

# Teste com debug
DEBUG_SCHEMAS=true pnpm build

# ForÃ§a rebuild
FORCE_SCHEMA_REBUILD=true pnpm build

# ProduÃ§Ã£o
NODE_ENV=production SITE_URL=https://matrix-protocol.org pnpm build

# Override de schema URL
SCHEMA_BASE_URL=https://custom.domain.com/schemas pnpm build
```

## CenÃ¡rios de Teste

### CenÃ¡rio 1: Desenvolvimento Local
```bash
# Setup
NODE_ENV=development
SITE_URL=http://localhost:3000

# Resultado esperado
$id: "http://localhost:3000/schemas/mef/uki/1.0.0"
```

### CenÃ¡rio 2: ProduÃ§Ã£o
```bash
# Setup
NODE_ENV=production
SITE_URL=https://matrix-protocol.org

# Resultado esperado
$id: "https://matrix-protocol.org/schemas/mef/uki/1.0.0"
```

### CenÃ¡rio 3: Ambiente Customizado
```bash
# Setup
SCHEMA_BASE_URL=https://cdn.example.com/schemas

# Resultado esperado
$id: "https://cdn.example.com/schemas/mef/uki/1.0.0"
```

### CenÃ¡rio 4: Diferentes Portas
```bash
# Setup
NITRO_HOST=0.0.0.0
NITRO_PORT=8080

# Resultado esperado
$id: "http://0.0.0.0:8080/schemas/mef/uki/1.0.0"
```

## ValidaÃ§Ã£o Manual

### 1. Verificar Content Hook
```bash
# Limpar e buildar com debug
pnpm clean
DEBUG_SCHEMAS=true pnpm dev

# Verificar logs: [Content Hook] Processing schema: ...
# Verificar arquivos: URLs atualizadas nos YAMLs
```

### 2. Verificar Build Hook
```bash
# Build com debug
DEBUG_SCHEMAS=true pnpm build

# Verificar logs:
# âœ… Schema processing completed via build hook
# âœ… Schema validation passed
```

### 3. Verificar Nitro Hook (ProduÃ§Ã£o)
```bash
# Build produÃ§Ã£o
NODE_ENV=production pnpm build

# Verificar logs:
# ðŸ”„ Final schema validation for production Nitro build...
# âœ… Production schema validation completed
```

### 4. Verificar URLs nos Arquivos
```bash
# Verificar um schema especÃ­fico
cat content/pt/docs/frameworks/specifications/mef/mef-uki-schema.yaml | grep '$id'

# Deve mostrar URL correta para o ambiente
```

## Testes de Falha

### 1. Schema InvÃ¡lido
```bash
# Corromper um schema temporariamente
echo "invalid: yaml: content" >> content/pt/docs/frameworks/specifications/mef/mef-uki-schema.yaml

# Executar validaÃ§Ã£o
pnpm schemas:validate

# Deve falhar com erro claro
```

### 2. Build ProduÃ§Ã£o com Schema InvÃ¡lido
```bash
# Com schema corrompido
NODE_ENV=production pnpm build

# Deve falhar o build inteiro
```

### 3. URLs Malformadas
```bash
# Testar com URL base invÃ¡lida
SCHEMA_BASE_URL="not-a-url" pnpm schemas:process

# Deve gerar URLs vÃ¡lidas ou falhar graciosamente
```

## Logs Esperados

### Desenvolvimento Normal
```
[Content Hook] Processing schema: /content/pt/docs/frameworks/specifications/mef/mef-uki-schema.yaml
[Content Hook] Updated /content/pt/docs/frameworks/specifications/mef/mef-uki-schema.yaml: http://localhost:3000/schemas/mef/uki/1.0.0
âœ… Schema validation passed
ðŸŽ‰ Build completed! Schema URLs are ready for environment: development
```

### ProduÃ§Ã£o
```
ðŸ”„ Final schema validation for production Nitro build...
âœ… Production schema validation completed
ðŸŽ‰ Build completed! Schema URLs are ready for environment: production
```

### Debug Mode
```
ðŸ”„ Running schema processing before build...
ðŸ”„ Processing schema files before build...
âœ… Schema processing completed via build hook
âœ… Schema validation passed
```

## Troubleshooting

### Hook nÃ£o executa
- Verificar sintaxe do `nuxt.config.ts`
- Verificar versÃ£o do Nuxt 4.x
- Checar logs de erro durante startup

### URLs nÃ£o atualizam
- Verificar variÃ¡veis de ambiente
- ForÃ§ar rebuild: `FORCE_SCHEMA_REBUILD=true pnpm build`
- Verificar permissÃµes de escrita nos arquivos

### Build falha
- Verificar sintaxe YAML dos schemas
- Verificar se mÃ³dulo `yaml` estÃ¡ disponÃ­vel
- Checar logs especÃ­ficos do erro

### Performance
- Content hooks sÃ£o mais eficientes que build hooks
- Use `DEBUG_SCHEMAS=false` em produÃ§Ã£o
- Monitore tempo de build se muitos schemas