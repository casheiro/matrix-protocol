# MAL Arbitration Event Schema v1.0.0
# Matrix Arbiter Layer - Arbitration Events
# Normative canonical specification for conflict events requiring arbitration

$schema: https://json-schema.org/draft/2020-12/schema
$id: http://localhost:3000/schemas/mal/arbitration-event/1.0.0
version: 1.0.0
title: MAL Arbitration Event Schema
description: Canonical schema for MAL arbitration events in the Matrix Protocol
type: object
required:
  - schema
  - event_id
  - event_type
  - timestamp
  - candidates
  - user_moc_context
  - operation
  - conflict_details
properties:
  schema:
    type: string
    description: Schema version MAL Arbitration Event used
    pattern: ^[0-9]+\.[0-9]+$
    examples:
      - "1.0"
      - "1.1"
  event_id:
    type: string
    description: Unique identifier for the arbitration request
    pattern: ^mal-evt-[0-9]{8}-[0-9]+$
    examples:
      - mal-evt-20250826-001
      - mal-evt-20250827-042
  event_type:
    type: string
    description: Conflict classification
    enum:
      - H1
      - H2
      - H3
    examples:
      - H1
      - H2
  timestamp:
    type: string
    format: date-time
    description: Event creation timestamp
    examples:
      - 2025-08-26T14:30:25.123Z
  candidates:
    type: array
    description: Array of conflicting entities with complete metadata
    minItems: 2
    items:
      type: object
      required:
        - uki_ref
        - scope_ref
        - domain_ref
        - maturity_level
      properties:
        uki_ref:
          type: string
          description: Candidate UKI identifier
          pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
          examples:
            - uki:squad-x:rule:data-retention-30d
            - uki:squad-x:rule:data-retention-7d
        scope_ref:
          type: string
          description: MOC scope reference
          pattern: ^[a-z0-9-]+$
          examples:
            - squad-x
            - tribe-alpha
            - organization
        domain_ref:
          type: string
          description: MOC domain reference
          pattern: ^[a-z0-9-]+$
          examples:
            - security
            - technical
            - business
        type_ref:
          type: string
          description: Knowledge type
          pattern: ^[a-z0-9_]+$
          examples:
            - rule
            - pattern
            - guideline
            - policy
        maturity_level:
          type: string
          description: Maturity classification
          pattern: ^[a-z0-9_]+$
          examples:
            - draft
            - validated
            - endorsed
            - experimental
        version:
          type: string
          description: UKI version
          pattern: ^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)$
          examples:
            - 1.0.0
            - 2.1.3
        created_date:
          type: string
          format: date
          description: UKI creation date
        last_modified:
          type: string
          format: date
          description: Last modification date
        authority_ref:
          type: string
          description: Creating authority reference
          examples:
            - tech_lead
            - developer
            - architect
        evidence_refs:
          type: array
          description: Supporting evidence references
          items:
            type: string
          examples:
            - - uki:org:policy:lgpd-compliance
              - doc:audit-logs-2024
        conflict_metadata:
          type: object
          description: Specific metadata for this conflict
          properties:
            conflicting_aspects:
              type: array
              description: Specific conflicting aspects
              items:
                type: string
              examples:
                - - retention_period
                  - enforcement_method
            semantic_similarity:
              type: number
              description: Semantic similarity with other candidates (0.0 to 1.0)
              minimum: 0
              maximum: 1
              examples:
                - 0.85
                - 0.72
            usage_frequency:
              type: integer
              description: Usage or reference frequency
              minimum: 0
              examples:
                - 15
                - 3
            stakeholder_preference:
              type: object
              description: Stakeholder preferences
              properties:
                primary_stakeholder:
                  type: string
                  description: Primary stakeholder
                preference_strength:
                  type: string
                  enum:
                    - weak
                    - moderate
                    - strong
              additionalProperties: false
          additionalProperties: true
      additionalProperties: false
  user_moc_context:
    type: object
    description: User hierarchical claims and authority levels
    required:
      - user_id
      - scopes
      - authority_level
    properties:
      user_id:
        type: string
        description: User unique identifier
        examples:
          - dev001
          - john.doe
      scopes:
        type: array
        description: User scope hierarchy
        items:
          type: string
          pattern: ^[a-z0-9-]+$
        minItems: 1
        examples:
          - - squad-x
            - tribe-alpha
            - organization
      authority_level:
        type: string
        description: User authority designation
        examples:
          - developer
          - squad_lead
          - tech_lead
          - architect
      domain_access:
        type: array
        description: User accessible domains
        items:
          type: string
          pattern: ^[a-z0-9-]+$
        examples:
          - - technical
            - security
      session_context:
        type: object
        description: Current session context
        properties:
          session_id:
            type: string
            description: Session ID
          workflow_ref:
            type: string
            description: Workflow that originated the conflict
            pattern: ^zof-[a-z0-9-]+$
          operation_context:
            type: string
            description: Current operation context
        additionalProperties: true
    additionalProperties: false
  operation:
    type: string
    description: Requested operation type
    enum:
      - read
      - enrich
      - promote
    examples:
      - enrich
      - promote
  conflict_details:
    type: object
    description: Type-specific conflict details
    required:
      - conflict_description
      - detection_method
    properties:
      conflict_description:
        type: string
        description: Textual description of the conflict
        minLength: 50
        examples:
          - Two equivalent-scope security rules in conflict over retention period
      detection_method:
        type: string
        description: Method used to detect the conflict
        enum:
          - semantic_analysis
          - rule_engine
          - manual_escalation
          - automated_workflow
        examples:
          - semantic_analysis
          - automated_workflow
      detection_timestamp:
        type: string
        format: date-time
        description: When the conflict was detected
      severity:
        type: string
        description: Conflict severity
        enum:
          - low
          - medium
          - high
          - critical
        default: medium
        examples:
          - high
          - critical
      h1_details:
        type: object
        description: Specific details for H1 horizontal conflicts
        properties:
          scope_equivalence:
            type: boolean
            description: UKIs operate in equivalent scopes
            default: true
          semantic_overlap:
            type: number
            description: Semantic overlap percentage
            minimum: 0
            maximum: 1
            examples:
              - 0.85
              - 0.92
          contradictory_directives:
            type: array
            description: Identified contradictory directives
            items:
              type: string
            examples:
              - - "retention_period: 30d vs 7d"
                - "enforcement: automatic vs manual"
          domain_intersection:
            type: array
            description: Domains where intersection occurs
            items:
              type: string
            examples:
              - - security
                - compliance
        additionalProperties: false
      h2_details:
        type: object
        description: Specific details for H2 concurrent enrichment
        properties:
          concurrent_requests:
            type: array
            description: Detected concurrent requests
            items:
              type: object
              required:
                - request_id
                - timestamp
                - user_id
              properties:
                request_id:
                  type: string
                  description: Concurrent request ID
                timestamp:
                  type: string
                  format: date-time
                user_id:
                  type: string
                  description: User who made the request
                priority:
                  type: string
                  enum:
                    - low
                    - medium
                    - high
              additionalProperties: false
          temporal_window_ms:
            type: integer
            description: Concurrency temporal window
            minimum: 0
            examples:
              - 30000
              - 60000
          resource_contention:
            type: string
            description: Resource under contention
            examples:
              - oracle_enrichment_lock
              - uki_modification_lock
          first_request_advantage:
            type: boolean
            description: First request has temporal advantage
            default: false
        additionalProperties: false
      h3_details:
        type: object
        description: Specific details for H3 promotion contention
        properties:
          promotion_candidates:
            type: array
            description: Promotion candidates
            items:
              type: object
              required:
                - uki_ref
                - target_scope
                - promotion_rationale
              properties:
                uki_ref:
                  type: string
                  pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
                target_scope:
                  type: string
                  description: Promotion target scope
                promotion_rationale:
                  type: string
                  description: Promotion rationale
                  minLength: 50
                evidence_strength:
                  type: string
                  enum:
                    - weak
                    - moderate
                    - strong
                    - compelling
                sponsor_authority:
                  type: string
                  description: Authority sponsoring the promotion
              additionalProperties: false
          target_level:
            type: string
            description: Target hierarchical level
            examples:
              - tribe
              - organization
          promotion_criteria:
            type: array
            description: Applicable promotion criteria
            items:
              type: string
            examples:
              - - evidence_density
                - stakeholder_approval
                - impact_assessment
          competing_authorities:
            type: boolean
            description: Identified competing authorities
            default: false
        additionalProperties: false
    additionalProperties: false
  policy_ref:
    type: string
    description: Optional reference to specific MOC arbitration policy
    pattern: ^moc:arbitration:[a-z0-9_-]+$
    examples:
      - moc:arbitration:security_priority
      - moc:arbitration:default
  policy_context:
    type: object
    description: Additional policy context
    properties:
      escalation_source:
        type: string
        description: Escalation source
        enum:
          - zof_workflow
          - manual_request
          - automated_detection
          - system_alert
        examples:
          - zof_workflow
          - automated_detection
      urgency_level:
        type: string
        description: Arbitration urgency level
        enum:
          - low
          - normal
          - high
          - urgent
        default: normal
      business_impact:
        type: string
        description: Business impact
        enum:
          - minimal
          - moderate
          - significant
          - critical
        examples:
          - moderate
          - significant
      deadline:
        type: string
        format: date-time
        description: Resolution deadline (optional)
      stakeholders:
        type: array
        description: Stakeholders interested in the decision
        items:
          type: string
        examples:
          - - security-team
            - compliance-officer
            - product-owner
    additionalProperties: false
  technical_context:
    type: object
    description: Technical context of the conflict
    properties:
      system_state:
        type: object
        description: Current system state
        properties:
          active_workflows:
            type: integer
            description: Number of active workflows
            minimum: 0
          system_load:
            type: string
            enum:
              - low
              - medium
              - high
              - overloaded
          maintenance_window:
            type: boolean
            description: System in maintenance window
            default: false
        additionalProperties: true
      environment:
        type: string
        description: Environment where the conflict occurs
        enum:
          - development
          - staging
          - production
          - test
        examples:
          - production
          - staging
      related_systems:
        type: array
        description: Systems related to the conflict
        items:
          type: string
        examples:
          - - user-management
            - audit-log
            - compliance-dashboard
      dependencies:
        type: array
        description: Dependencies that may be affected
        items:
          type: string
        examples:
          - - authentication-service
            - data-retention-policy
    additionalProperties: false
  tracking_metadata:
    type: object
    description: Metadata for tracking and auditing
    properties:
      correlation_id:
        type: string
        description: Correlation ID for tracking
        examples:
          - corr-2025-08-26-001
      parent_event_id:
        type: string
        description: Parent event that originated this conflict
        pattern: ^[a-z]+-[0-9-]+$
        examples:
          - zof-eval-20250826-001
      trace_id:
        type: string
        description: Distributed trace ID
        examples:
          - trace-abc123def456
      request_source:
        type: string
        description: Arbitration request source
        examples:
          - zof-workflow-agent
          - manual-escalation
          - automated-detector
      processing_hints:
        type: object
        description: Processing hints
        properties:
          priority_boost:
            type: boolean
            description: Elevated priority
            default: false
          fast_track:
            type: boolean
            description: Accelerated processing
            default: false
          require_human_review:
            type: boolean
            description: Requires human review
            default: false
        additionalProperties: false
    additionalProperties: false
additionalProperties: false
allOf:
  - if:
      properties:
        event_type:
          const: H1
    then:
      properties:
        conflict_details:
          required:
            - h1_details
  - if:
      properties:
        event_type:
          const: H2
    then:
      properties:
        conflict_details:
          required:
            - h2_details
  - if:
      properties:
        event_type:
          const: H3
    then:
      properties:
        conflict_details:
          required:
            - h3_details
  - if:
      properties:
        operation:
          const: enrich
    then:
      properties:
        candidates:
          minItems: 2
  - if:
      properties:
        event_type:
          const: H3
    then:
      properties:
        conflict_details:
          properties:
            h3_details:
              properties:
                promotion_candidates:
                  minItems: 2
