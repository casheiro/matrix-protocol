# MAL Decision Record Schema v1.0.0
# Matrix Arbiter Layer - Decision Records
# Normative canonical specification for arbitration decision records

$schema: https://json-schema.org/draft/2020-12/schema
$id: http://localhost:3000/schemas/mal/decision-record/1.0.0
version: 1.0.0
title: MAL Decision Record Schema
description: Canonical schema for MAL decision records in Matrix Protocol
type: object
required:
  - schema
  - decision_id
  - event_ref
  - outcome
  - precedence_applied
  - epistemic_rationale
  - audit
properties:
  schema:
    type: string
    description: Schema version MAL Decision Record used
    pattern: ^[0-9]+\.[0-9]+$
    examples:
      - "1.0"
      - "1.1"
  decision_id:
    type: string
    description: Unique identifier of MAL decision
    pattern: ^mal-dec-[0-9]{8}-[a-z0-9]+-[0-9]+$
    examples:
      - mal-dec-20250826-h1-001
      - mal-dec-20250827-h2-042
  event_ref:
    type: string
    description: Reference to originating arbitration event
    pattern: ^mal-evt-[0-9]{8}-[0-9]+$
    examples:
      - mal-evt-20250826-001
      - mal-evt-20250827-042
  outcome:
    type: string
    description: Result of arbitration decision
    enum:
      - winner
      - coexist
      - reject_all
      - defer
    examples:
      - winner
      - coexist
  winner:
    type: string
    description: UKI chosen as authoritative (required if outcome=winner)
    pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
    examples:
      - uki:squad-x:rule:retencao-dados-30d
  losers:
    type: array
    description: UKIs defeated in arbitration
    items:
      type: string
      pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
    examples:
      - - uki:squad-x:rule:retencao-dados-7d
  coexistence_arrangement:
    type: object
    description: Coexistence arrangement (required if outcome=coexist)
    properties:
      partition_strategy:
        type: string
        description: Applied partitioning strategy
        enum:
          - scope_partition
          - domain_partition
          - temporal_partition
          - conditional_partition
        examples:
          - scope_partition
      partition_rules:
        type: array
        description: Specific partitioning rules
        items:
          type: object
          required:
            - uki_ref
            - assigned_context
            - conditions
          properties:
            uki_ref:
              type: string
              pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
              description: UKI being partitioned
            assigned_context:
              type: object
              description: Context assigned to UKI
              properties:
                scope_restriction:
                  type: string
                  description: Scope restriction
                domain_restriction:
                  type: string
                  description: Domain restriction
                temporal_restriction:
                  type: string
                  description: Temporal restriction
                conditional_rules:
                  type: array
                  description: Conditional rules
                  items:
                    type: string
              additionalProperties: false
            conditions:
              type: array
              description: Conditions for application
              items:
                type: string
              examples:
                - - user.scope == 'squad-x'
                  - operation == 'read'
            precedence_order:
              type: integer
              description: Precedence order (1 = highest)
              minimum: 1
          additionalProperties: false
      conflict_resolution_rules:
        type: array
        description: Rules for future conflict resolution
        items:
          type: string
        examples:
          - In case of overlap, squad-x has precedence over squad-y
    additionalProperties: false
  rejection_rationale:
    type: object
    description: Rejection rationale (required if outcome=reject_all)
    properties:
      primary_reason:
        type: string
        description: Primary reason for rejection
        enum:
          - insufficient_evidence
          - policy_violation
          - authority_conflict
          - semantic_inconsistency
          - quality_standards_not_met
          - organizational_conflict
        examples:
          - insufficient_evidence
          - quality_standards_not_met
      detailed_analysis:
        type: string
        description: Detailed analysis of rejection
        minLength: 100
        examples:
          - None of the candidate UKIs meet the minimum evidence criteria established in the organizational MOC
      improvement_recommendations:
        type: array
        description: Improvement recommendations
        items:
          type: string
        examples:
          - Add regulatory compliance evidence
          - Obtain approval from competent authority
      alternative_paths:
        type: array
        description: Suggested alternative paths
        items:
          type: string
        examples:
          - Create new UKI with adequate evidence
          - Escalation to higher authority
    additionalProperties: false
  deferral_details:
    type: object
    description: Deferral details (required if outcome=defer)
    properties:
      deferral_reason:
        type: string
        description: Reason for deferral
        enum:
          - insufficient_context
          - policy_ambiguity
          - human_judgment_required
          - external_dependency
          - conflicting_authorities
          - system_limitations
        examples:
          - human_judgment_required
          - policy_ambiguity
      required_actions:
        type: array
        description: Required actions before re-arbitration
        items:
          type: object
          required:
            - action_type
            - description
            - responsible_party
          properties:
            action_type:
              type: string
              enum:
                - human_review
                - policy_clarification
                - evidence_collection
                - authority_escalation
            description:
              type: string
              minLength: 30
            responsible_party:
              type: string
              description: Party responsible for action
            deadline:
              type: string
              format: date-time
              description: Deadline for completion
          additionalProperties: false
      re_arbitration_conditions:
        type: array
        description: Conditions for new arbitration
        items:
          type: string
        examples:
          - Precedence policy clarified by MOC
          - Human review completed
      escalation_contacts:
        type: array
        description: Escalation contacts
        items:
          type: string
        examples:
          - governance-board
          - technical-lead
    additionalProperties: false
  precedence_applied:
    type: array
    description: Precedence rules applied in decision
    minItems: 1
    items:
      type: object
      required:
        - rule_id
        - description
        - weight
        - application_result
      properties:
        rule_id:
          type: string
          description: Precedence rule identifier
          pattern: ^P[0-9]+_[a-z_]+$
          examples:
            - P1_authority_weight
            - P3_maturity_level
        description:
          type: string
          description: Description of applied rule
          minLength: 20
          examples:
            - Higher hierarchical authority weight
            - Validated knowledge supersedes experimental
        weight:
          type: number
          description: Weight applied to rule (0.0 to 1.0)
          minimum: 0
          maximum: 1
          examples:
            - 0.8
            - 0.6
            - 0.4
        application_result:
          type: object
          description: Result of rule application
          required:
            - rule_outcome
            - impact_on_decision
          properties:
            rule_outcome:
              type: string
              description: Specific rule outcome
              examples:
                - tech_lead > developer
                - validated > experimental
            impact_on_decision:
              type: string
              description: How it impacted final decision
              enum:
                - decisive
                - supportive
                - neutral
                - contradictory
              examples:
                - decisive
                - supportive
            numerical_score:
              type: number
              description: Numerical score (if applicable)
              minimum: 0
              maximum: 1
            compared_entities:
              type: array
              description: Entities compared by this rule
              items:
                type: object
                required:
                  - entity_ref
                  - entity_value
                  - score
                properties:
                  entity_ref:
                    type: string
                    pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
                  entity_value:
                    type: string
                    description: Entity value for this rule
                  score:
                    type: number
                    minimum: 0
                    maximum: 1
                additionalProperties: false
          additionalProperties: false
        policy_source:
          type: string
          description: Source of policy defining this rule
          examples:
            - moc:arbitration:default
            - protocol_canonical
        custom_parameters:
          type: object
          description: Custom rule parameters
          additionalProperties: true
      additionalProperties: false
  epistemic_rationale:
    type: object
    description: Epistemic explanation aligned with MEP principles
    required:
      - summary
      - reasoning
      - references
    properties:
      summary:
        type: string
        description: Brief decision rationale
        minLength: 50
        maxLength: 500
        examples:
          - Validated maturity and stronger regulatory evidence determined the choice of 30-day rule
      reasoning:
        type: string
        description: Detailed explanation of epistemic reasoning
        minLength: 100
        examples:
          - While both UKIs operate in equivalent squad scope, the 30-day retention rule demonstrates greater
            epistemological maturity through its 'validated' status and more robust regulatory evidence linked to
            LGPD compliance requirements
      references:
        type: object
        description: References used in decision
        required:
          - moc_nodes
          - mef_evidence
        properties:
          moc_nodes:
            type: array
            description: Referenced MOC nodes
            items:
              type: string
              pattern: ^[a-z0-9.-]+$
            examples:
              - - hierarchies.scope.squad-x
                - hierarchies.domain.security
          mef_evidence:
            type: array
            description: Referenced MEF evidence
            items:
              type: string
              pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
            examples:
              - - uki:org:policy:lgpd-compliance
          external_references:
            type: array
            description: External references (documents, regulations)
            items:
              type: string
            examples:
              - - doc:logs-auditoria-2024
                - reg:lgpd-art-6
          policy_references:
            type: array
            description: Policy references used
            items:
              type: string
              pattern: ^moc:arbitration:[a-z0-9_-]+$
            examples:
              - - moc:arbitration:security_priority
        additionalProperties: false
      mep_alignment:
        type: object
        description: Alignment with MEP principles
        properties:
          epistemic_humility:
            type: string
            description: How it demonstrates epistemic humility
            examples:
              - Decision based on specific organizational criteria, recognizing contextual limitations
          derived_authority:
            type: string
            description: How it respects derived authority
            examples:
              - Authority derives from organizational MOC and policy configuration
          contextual_knowledge:
            type: string
            description: How it recognizes contextual knowledge
            examples:
              - Decision specific to squad-x context in security domain
          responsible_promotion:
            type: string
            description: How it practices responsible promotion
            examples:
              - Based on adequate evidence and validation by competent authority
          explanatory_coherence:
            type: string
            description: How it maintains explanatory coherence
            examples:
              - Decision consistent with precedents and organizational policies
        additionalProperties: false
      uncertainty_assessment:
        type: object
        description: Uncertainty assessment
        properties:
          confidence_level:
            type: number
            description: Confidence level in decision (0.0 to 1.0)
            minimum: 0
            maximum: 1
            examples:
              - 0.85
              - 0.92
          risk_factors:
            type: array
            description: Identified risk factors
            items:
              type: string
            examples:
              - Regulatory evidence may change
              - Organizational context evolving
          sensitivity_analysis:
            type: string
            description: Decision sensitivity analysis
            examples:
              - Decision robust to small variations in criteria
          alternative_scenarios:
            type: array
            description: Alternative scenarios considered
            items:
              type: string
            examples:
              - If additional evidence emerges, re-evaluation may be necessary
        additionalProperties: false
    additionalProperties: false
  actions:
    type: array
    description: Actions to be executed based on decision
    items:
      type: string
      pattern: "^(allow_enrich|defer_enrich|gate_enrich|deprecate|partition_scope|promote|escalate):"
      examples:
        - allow_enrich:zof-auth-jwt-implementation-002
        - deprecate:uki:squad-x:rule:retencao-dados-7d
        - partition_scope:squad-x:read_only
  audit:
    type: object
    description: Mandatory audit information
    required:
      - decided_at
      - decided_by
      - timeout_used_ms
    properties:
      decided_at:
        type: string
        format: date-time
        description: Precise decision timestamp
        examples:
          - 2025-08-26T14:30:25.123Z
      decided_by:
        type: string
        description: Identifier of MAL version that made the decision
        pattern: ^mal-v[0-9]+\.[0-9]+\.[0-9]+$
        examples:
          - mal-v1.0.0
          - mal-v1.2.3
      timeout_used_ms:
        type: integer
        description: Processing time used in milliseconds
        minimum: 0
        maximum: 600000
        examples:
          - 1250
          - 5000
      arbitration_timeout_ms:
        type: integer
        description: Configured timeout for arbitration
        minimum: 1000
        maximum: 600000
        examples:
          - 2000
          - 10000
      processing_details:
        type: object
        description: Processing details
        properties:
          algorithm_version:
            type: string
            description: Arbitration algorithm version
            examples:
              - precedence-v1.0
              - weighted-v2.1
          policy_config_version:
            type: string
            description: Policy configuration version
            examples:
              - moc-policy-v1.2
          computational_complexity:
            type: string
            description: Computational complexity of decision
            enum:
              - low
              - medium
              - high
              - very_high
          memory_usage_mb:
            type: number
            description: Memory usage during processing
            minimum: 0
          database_queries:
            type: integer
            description: Number of database queries
            minimum: 0
        additionalProperties: true
      quality_indicators:
        type: object
        description: Decision quality indicators
        properties:
          consistency_check:
            type: boolean
            description: Consistency check passed
          precedent_alignment:
            type: number
            description: Alignment with precedents (0.0 to 1.0)
            minimum: 0
            maximum: 1
          stakeholder_impact_assessment:
            type: string
            description: Stakeholder impact assessment
            enum:
              - minimal
              - moderate
              - significant
              - major
        additionalProperties: false
    additionalProperties: false
  communication_metadata:
    type: object
    description: Metadata for decision communication
    properties:
      notification_required:
        type: boolean
        description: Notification is required
        default: true
      notification_targets:
        type: array
        description: Notification targets
        items:
          type: string
        examples:
          - original_requester
          - affected_stakeholders
          - governance_board
      explanation_template_ref:
        type: string
        description: Reference to explanation template
        pattern: ^oif-exp-template-[a-z0-9-]+$
        examples:
          - oif-exp-template-standard
          - oif-exp-template-technical
      urgency_level:
        type: string
        description: Communication urgency level
        enum:
          - low
          - normal
          - high
          - urgent
        default: normal
    additionalProperties: false
additionalProperties: false
allOf:
  - if:
      properties:
        outcome:
          const: winner
    then:
      required:
        - winner
  - if:
      properties:
        outcome:
          const: coexist
    then:
      required:
        - coexistence_arrangement
  - if:
      properties:
        outcome:
          const: reject_all
    then:
      required:
        - rejection_rationale
  - if:
      properties:
        outcome:
          const: defer
    then:
      required:
        - deferral_details
  - properties:
      precedence_applied:
        minItems: 1
