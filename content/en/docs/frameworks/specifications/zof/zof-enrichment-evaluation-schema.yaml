# ZOF Enrichment Evaluation Schema v1.0.0
# Zion Orchestration Framework - EvaluateForEnrich Evaluation
# Normative canonical specification for EvaluateForEnrich checkpoint

$schema: https://json-schema.org/draft/2020-12/schema
$id: http://localhost:3000/schemas/zof/enrichment-evaluation/1.0.0
version: 1.0.0
title: ZOF Enrichment Evaluation Schema
description: Canonical schema for EvaluateForEnrich checkpoint in ZOF
type: object
required:
  - schema
  - evaluation_id
  - workflow_ref
  - act_output
  - user_context
  - evaluation_result
  - metadata
properties:
  schema:
    type: string
    description: Schema version ZOF Enrichment Evaluation used
    pattern: ^[0-9]+\.[0-9]+$
    examples:
      - "1.0"
      - "1.1"
  evaluation_id:
    type: string
    description: Unique identifier of the evaluation
    pattern: ^zof-eval-[a-z0-9-]+-[0-9]+$
    examples:
      - zof-eval-auth-flow-001
      - zof-eval-request-workflow-042
  workflow_ref:
    type: string
    description: Reference to workflow ZOF
    pattern: ^zof-[a-z0-9-]+$
    examples:
      - zof-request-flow
      - zof-auth-jwt-implementation
  act_output:
    type: object
    description: Output from Act state to be evaluated for enrichment
    required:
      - result_type
      - content
      - metadata
    properties:
      result_type:
        type: string
        description: Type of result produced
        enum:
          - implementation
          - documentation
          - configuration
          - process
          - decision
          - pattern
          - guideline
          - policy
        examples:
          - implementation
          - pattern
      content:
        type: string
        description: Content of the result to be evaluated
        minLength: 100
        examples:
          - JWT authentication implementation with refresh tokens and specific claims validation for organizational
            context
      metadata:
        type: object
        description: Result metadata
        required:
          - created_at
          - creator
        properties:
          created_at:
            type: string
            format: date-time
            description: Result creation timestamp
          creator:
            type: string
            description: Result creator
            examples:
              - user:developer
              - system:automated
          complexity_score:
            type: number
            description: Complexity score (0.0 to 1.0)
            minimum: 0
            maximum: 1
          related_ukis:
            type: array
            description: Related UKIs consulted during Act
            items:
              type: string
              pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
          technologies_used:
            type: array
            description: Technologies used in the result
            items:
              type: string
        additionalProperties: true
    additionalProperties: false
  user_context:
    type: object
    description: Context of the user requesting enrichment
    required:
      - user_id
      - moc_context
    properties:
      user_id:
        type: string
        description: Unique identifier of the user
        examples:
          - dev001
          - john.doe
      moc_context:
        type: object
        description: User's MOC context
        required:
          - scope_level
          - domain_access
          - authority_level
        properties:
          scope_level:
            type: string
            description: User's scope level
            pattern: ^[a-z0-9-]+$
            examples:
              - squad
              - tribe
              - organization
          domain_access:
            type: array
            description: Domains accessible to the user
            items:
              type: string
              pattern: ^[a-z0-9-]+$
            examples:
              - - technical
                - business
          authority_level:
            type: string
            description: User's authority level
            examples:
              - developer
              - tech_lead
              - architect
          escalation_paths:
            type: array
            description: Available escalation paths
            items:
              type: string
            examples:
              - - team_lead
                - architect
                - cto
        additionalProperties: false
      session_context:
        type: object
        description: Current session context
        properties:
          session_id:
            type: string
            description: Session ID
          workflow_history:
            type: array
            description: Workflow history in the session
            items:
              type: string
          current_task:
            type: string
            description: Current task being executed
        additionalProperties: true
    additionalProperties: false
  evaluation_result:
    type: object
    description: EvaluateForEnrich evaluation result
    required:
      - can_enrich_decision
      - moc_criteria_results
      - authority_validation
      - justification
    properties:
      can_enrich_decision:
        type: object
        description: Result of the can_enrich?() function
        required:
          - approved
          - confidence_score
          - evaluation_method
        properties:
          approved:
            type: boolean
            description: Approved for enrichment
            examples:
              - true
              - false
          confidence_score:
            type: number
            description: Confidence score (0.0 to 1.0)
            minimum: 0
            maximum: 1
            examples:
              - 0.85
              - 0.72
          evaluation_method:
            type: string
            description: Method used for evaluation
            enum:
              - minimum_profile
              - automated
              - manual
              - hybrid
            examples:
              - minimum_profile
              - automated
          scoring_breakdown:
            type: object
            description: Score breakdown details
            properties:
              semantic_novelty:
                type: number
                minimum: 0
                maximum: 1
              practical_value:
                type: number
                minimum: 0
                maximum: 1
              basic_authority:
                type: number
                minimum: 0
                maximum: 1
            additionalProperties: true
        additionalProperties: false
      moc_criteria_results:
        type: object
        description: Results from MOC criteria query
        required:
          - criteria_source
          - profile_used
          - individual_results
          - overall_result
        properties:
          criteria_source:
            type: string
            description: Source of criteria in MOC
            pattern: ^hierarchies\.evaluation_criteria\.nodes$
            examples:
              - hierarchies.evaluation_criteria.nodes
          profile_used:
            type: string
            description: Evaluation profile used
            examples:
              - standard
              - critical
              - minimal
          individual_results:
            type: object
            description: Individual results per criterion
            patternProperties:
              ^[a-z0-9_]+$:
                type: object
                required:
                  - criterion_name
                  - result
                  - score
                  - threshold_met
                properties:
                  criterion_name:
                    type: string
                    description: Criterion name
                    examples:
                      - relevance
                      - reusability
                      - impact
                  result:
                    type: string
                    description: Evaluation result
                    enum:
                      - pass
                      - fail
                      - warning
                      - not_applicable
                    examples:
                      - pass
                      - fail
                  score:
                    type: number
                    description: Score obtained
                    minimum: 0
                    maximum: 1
                  threshold_met:
                    type: boolean
                    description: Approval threshold met
                  explanation:
                    type: string
                    description: Result explanation
                    examples:
                      - Other developers will face the same problem
                  evidence:
                    type: array
                    description: Evidence supporting the result
                    items:
                      type: string
                additionalProperties: false
            additionalProperties: false
          overall_result:
            type: object
            description: Overall MOC evaluation result
            required:
              - passed
              - score
              - execution_method
            properties:
              passed:
                type: boolean
                description: Passed the overall evaluation
              score:
                type: number
                description: Overall weighted score
                minimum: 0
                maximum: 1
              execution_method:
                type: string
                description: Execution method used
                enum:
                  - all_pass_required
                  - weighted_scoring
                  - any_pass
                examples:
                  - weighted_scoring
              minimum_score_met:
                type: boolean
                description: Minimum score met (if weighted_scoring)
              failed_criteria:
                type: array
                description: Criteria that failed
                items:
                  type: string
            additionalProperties: false
        additionalProperties: false
      authority_validation:
        type: object
        description: Authority validation result
        required:
          - authorized
          - validation_method
          - required_authority
        properties:
          authorized:
            type: boolean
            description: User authorized for enrichment
          validation_method:
            type: string
            description: Validation method used
            enum:
              - moc_based
              - role_based
              - hybrid
            examples:
              - moc_based
          required_authority:
            type: string
            description: Required authority identified
            examples:
              - squad_lead
              - tech_lead
          user_authority:
            type: string
            description: User's current authority
            examples:
              - developer
              - tech_lead
          escalation_hint:
            type: string
            description: Escalation suggestion (if not authorized)
            examples:
              - Request approval via team_lead
          moc_nodes_cited:
            type: array
            description: MOC nodes used in validation
            items:
              type: string
            examples:
              - - hierarchies.scope.squad
                - hierarchies.domain.technical
        additionalProperties: false
      justification:
        type: object
        description: Epistemic justification of the decision
        required:
          - summary
          - reasoning
          - mep_alignment
        properties:
          summary:
            type: string
            description: Justification summary
            minLength: 50
            examples:
              - Knowledge approved based on high relevance and adequate authority
          reasoning:
            type: string
            description: Detailed reasoning
            minLength: 100
            examples:
              - The result demonstrates significant practical value for other developers facing similar JWT authentication
                problems...
          mep_alignment:
            type: object
            description: Alignment with MEP principles
            properties:
              epistemic_humility:
                type: string
                description: How it demonstrates epistemic humility
              derived_authority:
                type: string
                description: How it respects derived authority
              contextual_knowledge:
                type: string
                description: How it recognizes contextual knowledge
              responsible_promotion:
                type: string
                description: How it practices responsible promotion
              explanatory_coherence:
                type: string
                description: How it maintains explanatory coherence
            additionalProperties: false
        additionalProperties: false
      conflict_detection:
        type: object
        description: H1/H2/H3 conflict detection result
        properties:
          conflicts_detected:
            type: boolean
            description: Conflicts were detected
            default: false
          conflict_types:
            type: array
            description: Types of conflicts detected
            items:
              type: string
              enum:
                - H1
                - H2
                - H3
          conflicting_ukis:
            type: array
            description: Conflicting UKIs identified
            items:
              type: string
              pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
          mal_invocation_required:
            type: boolean
            description: MAL invocation required
            default: false
          mal_event_ref:
            type: string
            description: Reference to MAL event (if invoked)
            pattern: ^mal-evt-[0-9]{8}-[0-9]+$
        additionalProperties: false
      scope_mode_validation:
        type: object
        description: Scope mode validation for multi-scope operations
        properties:
          scope_mode:
            type: string
            description: Scope mode applied
            enum:
              - any
              - all
            examples:
              - any
              - all
          affected_scopes:
            type: array
            description: Scopes affected by enrichment
            items:
              type: string
            examples:
              - - squad-a
                - squad-b
          validation_results:
            type: object
            description: Results per scope
            patternProperties:
              ^[a-z0-9-]+$:
                type: object
                properties:
                  scope_name:
                    type: string
                  validated:
                    type: boolean
                  reason:
                    type: string
                additionalProperties: false
            additionalProperties: false
          overall_validation:
            type: boolean
            description: Overall scope mode validation
        additionalProperties: false
    additionalProperties: false
  recommended_actions:
    type: array
    description: Recommended actions based on evaluation
    items:
      type: object
      required:
        - action_type
        - description
        - priority
      properties:
        action_type:
          type: string
          description: Type of recommended action
          enum:
            - proceed_to_enrich
            - proceed_to_review
            - request_approval
            - escalate_authority
            - invoke_mal
            - gather_more_evidence
            - refine_result
            - abort_workflow
          examples:
            - proceed_to_enrich
            - request_approval
        description:
          type: string
          description: Action description
          minLength: 20
          examples:
            - Proceed to Oracle enrichment with validated knowledge
        priority:
          type: string
          description: Action priority
          enum:
            - low
            - medium
            - high
            - critical
          examples:
            - high
            - medium
        parameters:
          type: object
          description: Action-specific parameters
          additionalProperties: true
      additionalProperties: false
  metadata:
    type: object
    description: Evaluation metadata
    required:
      - evaluation_timestamp
      - evaluator
      - duration_ms
    properties:
      evaluation_timestamp:
        type: string
        format: date-time
        description: Evaluation timestamp
      evaluator:
        type: string
        description: Entity that executed the evaluation
        examples:
          - workflow-agent
          - manual-reviewer
          - automated-system
      duration_ms:
        type: integer
        description: Evaluation duration in milliseconds
        minimum: 0
      evaluation_version:
        type: string
        description: Evaluation system version
        examples:
          - zof-eval-v1.0.0
      performance_metrics:
        type: object
        description: Evaluation performance metrics
        properties:
          moc_query_time_ms:
            type: integer
            description: MOC query time
          criteria_evaluation_time_ms:
            type: integer
            description: Criteria evaluation time
          authority_validation_time_ms:
            type: integer
            description: Authority validation time
          conflict_detection_time_ms:
            type: integer
            description: Conflict detection time
        additionalProperties: true
      environment_info:
        type: object
        description: Execution environment information
        properties:
          system_version:
            type: string
            description: ZOF system version
          moc_version:
            type: string
            description: MOC configuration version
          evaluation_mode:
            type: string
            enum:
              - development
              - staging
              - production
        additionalProperties: true
    additionalProperties: false
additionalProperties: false
allOf:
  - if:
      properties:
        evaluation_result:
          properties:
            can_enrich_decision:
              properties:
                approved:
                  const: false
    then:
      properties:
        recommended_actions:
          not:
            contains:
              properties:
                action_type:
                  const: proceed_to_enrich
  - if:
      properties:
        evaluation_result:
          properties:
            authority_validation:
              properties:
                authorized:
                  const: false
    then:
      properties:
        recommended_actions:
          contains:
            properties:
              action_type:
                enum:
                  - request_approval
                  - escalate_authority
  - if:
      properties:
        evaluation_result:
          properties:
            conflict_detection:
              properties:
                conflicts_detected:
                  const: true
    then:
      properties:
        recommended_actions:
          contains:
            properties:
              action_type:
                const: invoke_mal
