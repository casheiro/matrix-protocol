# ZOF Workflow Schema v1.0.0
# Zion Orchestration Framework - Workflow Definitions
# Normative canonical specification for AI-oriented conceptual workflows

$schema: https://json-schema.org/draft/2020-12/schema
$id: http://localhost:3000/schemas/zof/workflow/1.0.0
version: 1.0.0
title: ZOF Workflow Schema
description: Canonical schema for ZOF workflow definitions in Matrix Protocol
type: object
required:
  - schema
  - workflow_id
  - title
  - version
  - canonical_states
  - trigger_events
  - metadata
properties:
  schema:
    type: string
    description: ZOF Workflow schema version used
    pattern: ^[0-9]+\.[0-9]+$
    examples:
      - "1.0"
      - "1.1"
  workflow_id:
    type: string
    description: Unique workflow identifier
    pattern: ^zof-[a-z0-9-]+$
    examples:
      - zof-request-flow
      - zof-auth-jwt-implementation
  title:
    type: string
    description: Descriptive workflow title
    minLength: 10
    maxLength: 200
    examples:
      - Feature Implementation Workflow
      - JWT Authentication Flow
  version:
    type: string
    description: Workflow version (semantic versioning)
    pattern: ^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)$
    examples:
      - 1.0.0
      - 2.1.3
  canonical_states:
    type: object
    description: Mandatory sequence of canonical ZOF states
    required:
      - intake
      - understand
      - decide
      - act
      - evaluate_for_enrich
      - review
      - enrich
    properties:
      intake:
        type: object
        description: Context and requirements capture state
        required:
          - description
          - signals
          - transitions
        properties:
          description:
            type: string
            description: Intake state description
            examples:
              - Context capture and initial requirements
          signals:
            $ref: "#/$defs/state_signals"
          transitions:
            type: array
            description: Possible transitions from intake state
            items:
              $ref: "#/$defs/state_transition"
            minItems: 1
          activities:
            type: array
            description: Activities executed in the state
            items:
              type: string
            examples:
              - - Requirements collection
                - Context analysis
          completion_criteria:
            type: array
            description: Criteria to complete the state
            items:
              type: string
            examples:
              - - Requirements documented
                - Context understood
        additionalProperties: false
      understand:
        type: object
        description: Mandatory Oracle consultation state (UKIs)
        required:
          - description
          - signals
          - transitions
          - oracle_consultation
        properties:
          description:
            type: string
            description: Understand state description
            examples:
              - Mandatory Oracle consultation for existing knowledge
          signals:
            $ref: "#/$defs/state_signals"
          transitions:
            type: array
            items:
              $ref: "#/$defs/state_transition"
            minItems: 1
          oracle_consultation:
            type: object
            description: Mandatory Oracle consultation configuration
            required:
              - required
              - query_parameters
              - filter_criteria
            properties:
              required:
                type: boolean
                description: Oracle consultation is mandatory
                const: true
              query_parameters:
                type: object
                description: Oracle consultation parameters
                properties:
                  scope_filter:
                    type: array
                    description: Scope filters for consultation
                    items:
                      type: string
                  domain_filter:
                    type: array
                    description: Domain filters for consultation
                    items:
                      type: string
                  semantic_query:
                    type: string
                    description: Semantic query to Oracle
                additionalProperties: false
              filter_criteria:
                type: object
                description: MOC-based filtering criteria
                properties:
                  user_context_required:
                    type: boolean
                    description: Requires user context for filtering
                    default: true
                  authority_validation:
                    type: boolean
                    description: Validate authority for returned UKIs
                    default: true
                additionalProperties: false
            additionalProperties: false
        additionalProperties: false
      decide:
        type: object
        description: Decision state based on existing knowledge
        required:
          - description
          - signals
          - transitions
        properties:
          description:
            type: string
            description: Decide state description
            examples:
              - Decision based on Oracle knowledge and context
          signals:
            $ref: "#/$defs/state_signals"
          transitions:
            type: array
            items:
              $ref: "#/$defs/state_transition"
            minItems: 1
          decision_criteria:
            type: array
            description: Decision-making criteria
            items:
              type: object
              required:
                - criterion
                - weight
              properties:
                criterion:
                  type: string
                  description: Decision criterion
                weight:
                  type: number
                  minimum: 0
                  maximum: 1
              additionalProperties: false
        additionalProperties: false
      act:
        type: object
        description: Planned action execution state
        required:
          - description
          - signals
          - transitions
        properties:
          description:
            type: string
            description: Act state description
            examples:
              - Action execution based on decision made
          signals:
            $ref: "#/$defs/state_signals"
          transitions:
            type: array
            items:
              $ref: "#/$defs/state_transition"
            minItems: 1
          execution_parameters:
            type: object
            description: Action execution parameters
            properties:
              timeout_ms:
                type: integer
                description: Execution timeout
                minimum: 1000
              retry_policy:
                type: object
                description: Retry policy in case of failure
                properties:
                  max_retries:
                    type: integer
                    minimum: 0
                    maximum: 10
                  backoff_strategy:
                    type: string
                    enum:
                      - linear
                      - exponential
                      - fixed
                additionalProperties: false
            additionalProperties: false
        additionalProperties: false
      evaluate_for_enrich:
        type: object
        description: Mandatory enrichment evaluation checkpoint
        required:
          - description
          - signals
          - transitions
          - checkpoint_config
        properties:
          description:
            type: string
            description: EvaluateForEnrich checkpoint description
            examples:
              - Mandatory checkpoint for Oracle enrichment evaluation
          signals:
            $ref: "#/$defs/state_signals"
          transitions:
            type: array
            items:
              $ref: "#/$defs/state_transition"
            minItems: 2
          checkpoint_config:
            type: object
            description: Mandatory checkpoint configuration
            required:
              - can_enrich_function
              - moc_criteria_consultation
              - authority_validation
            properties:
              can_enrich_function:
                type: object
                description: can_enrich?() function configuration
                required:
                  - implementation
                  - criteria
                properties:
                  implementation:
                    type: string
                    description: Function implementation type
                    enum:
                      - manual
                      - automated
                      - hybrid
                      - minimum_profile
                    examples:
                      - minimum_profile
                      - automated
                  criteria:
                    type: array
                    description: Criteria evaluated by function
                    items:
                      type: string
                    examples:
                      - - semantic_novelty
                        - practical_value
                        - basic_authority
                additionalProperties: false
              moc_criteria_consultation:
                type: object
                description: Mandatory MOC criteria consultation
                required:
                  - required
                  - criteria_source
                properties:
                  required:
                    type: boolean
                    description: MOC consultation is mandatory
                    const: true
                  criteria_source:
                    type: string
                    description: Criteria source in MOC
                    pattern: ^hierarchies\.evaluation_criteria\.nodes$
                    examples:
                      - hierarchies.evaluation_criteria.nodes
                additionalProperties: false
              authority_validation:
                type: object
                description: Mandatory authority validation
                required:
                  - required
                  - validation_method
                properties:
                  required:
                    type: boolean
                    description: Authority validation is mandatory
                    const: true
                  validation_method:
                    type: string
                    description: Validation method
                    enum:
                      - moc_based
                      - role_based
                      - hybrid
                    examples:
                      - moc_based
                additionalProperties: false
              conflict_detection:
                type: object
                description: H1/H2/H3 conflict detection
                properties:
                  enabled:
                    type: boolean
                    description: Enable conflict detection
                    default: true
                  mal_invocation:
                    type: object
                    description: MAL invocation configuration
                    properties:
                      auto_invoke:
                        type: boolean
                        description: Automatically invoke MAL on conflicts
                        default: true
                      timeout_ms:
                        type: integer
                        description: Timeout for MAL arbitration
                        minimum: 1000
                        maximum: 600000
                        default: 2000
                    additionalProperties: false
                additionalProperties: false
            additionalProperties: false
        additionalProperties: false
      review:
        type: object
        description: Optional result validation state
        required:
          - description
          - signals
          - transitions
        properties:
          description:
            type: string
            description: Review state description
            examples:
              - Optional validation of action result
          signals:
            $ref: "#/$defs/state_signals"
          transitions:
            type: array
            items:
              $ref: "#/$defs/state_transition"
            minItems: 1
          review_criteria:
            type: array
            description: Review criteria
            items:
              type: string
            examples:
              - - Result quality
                - Requirements compliance
        additionalProperties: false
      enrich:
        type: object
        description: Conditional Oracle enrichment state
        required:
          - description
          - signals
          - transitions
        properties:
          description:
            type: string
            description: Enrich state description
            examples:
              - Conditional Oracle enrichment with new knowledge
          signals:
            $ref: "#/$defs/state_signals"
          transitions:
            type: array
            items:
              $ref: "#/$defs/state_transition"
            minItems: 1
          enrichment_config:
            type: object
            description: Enrichment configuration
            properties:
              scope_mode_validation:
                type: boolean
                description: Apply scope_mode validation
                default: true
              cross_boundary_handling:
                type: object
                description: Cross-boundary enrichment handling
                properties:
                  detect_scope_crossing:
                    type: boolean
                    default: true
                  detect_domain_crossing:
                    type: boolean
                    default: true
                  escalation_policy:
                    type: string
                    enum:
                      - block
                      - escalate
                      - defer
                    default: escalate
                additionalProperties: false
            additionalProperties: false
        additionalProperties: false
    additionalProperties: false
  trigger_events:
    type: array
    description: Canonical events that can trigger the workflow
    minItems: 1
    items:
      type: object
      required:
        - event_type
        - description
      properties:
        event_type:
          type: string
          description: Canonical event type
          enum:
            - knowledge.added
            - work.proposed
            - work.refine.requested
            - assistance.requested
            - test.authored
            - feedback.submitted
          examples:
            - work.proposed
            - knowledge.added
        description:
          type: string
          description: Trigger event description
          examples:
            - New work proposal received
        parameters:
          type: object
          description: Event-specific parameters
          additionalProperties: true
      additionalProperties: false
  workflow_patterns:
    type: string
    description: Classified workflow pattern
    enum:
      - request_flow
      - refinement_flow
      - ingestion_flow
      - assistance_flow
      - testing_flow
      - feedback_flow
    examples:
      - request_flow
      - ingestion_flow
  explainability_config:
    type: object
    description: Mandatory explainability configuration
    properties:
      signals_required:
        type: boolean
        description: Mandatory signals in each transition
        default: true
      context_tracking:
        type: boolean
        description: Mandatory context tracking
        default: true
      decision_recording:
        type: boolean
        description: Mandatory decision recording
        default: true
    additionalProperties: false
  metadata:
    type: object
    description: Workflow metadata
    required:
      - created_date
      - last_modified
      - maintainer
    properties:
      created_date:
        type: string
        format: date
        description: Workflow creation date
      last_modified:
        type: string
        format: date
        description: Last modification date
      maintainer:
        type: string
        description: Responsible for workflow maintenance
        examples:
          - platform-team
          - workflow-team
      change_summary:
        type: string
        description: Current version changes summary
      validation_status:
        type: string
        description: Workflow validation status
        enum:
          - valid
          - pending
          - invalid
      usage_contexts:
        type: array
        description: Contexts where workflow is applicable
        items:
          type: string
        examples:
          - - development
            - production
            - testing
    additionalProperties: false
additionalProperties: false
$defs:
  state_signals:
    type: object
    description: Mandatory explainability signals
    required:
      - context
      - decision
      - result
    properties:
      context:
        type: string
        description: What entered the state
        minLength: 20
        examples:
          - User story for JWT authentication received
      decision:
        type: string
        description: Why it transitioned
        minLength: 20
        examples:
          - Clear and complete story, proceed to understanding
      result:
        type: string
        description: What exited the state
        minLength: 20
        examples:
          - Requirements organized and context captured
    additionalProperties: false
  state_transition:
    type: object
    description: State transition
    required:
      - target_state
      - condition
      - description
    properties:
      target_state:
        type: string
        description: Transition target state
        enum:
          - intake
          - understand
          - decide
          - act
          - evaluate_for_enrich
          - review
          - enrich
          - complete
          - failed
      condition:
        type: string
        description: Condition for transition
        examples:
          - completion_criteria_met
          - oracle_consulted
          - can_enrich_approved
      description:
        type: string
        description: Transition description
        minLength: 10
        examples:
          - Transition to understanding after complete capture
    additionalProperties: false
allOf:
  - properties:
      canonical_states:
        description: Must contain all 7 mandatory canonical states
  - properties:
      canonical_states:
        properties:
          evaluate_for_enrich:
            properties:
              transitions:
                minItems: 2
