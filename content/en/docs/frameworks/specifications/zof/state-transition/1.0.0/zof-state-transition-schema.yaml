# ZOF State Transition Schema v1.0.0
# Zion Orchestration Framework - State Transitions
# Normative canonical specification for transitions between canonical states

$schema: https://json-schema.org/draft/2020-12/schema
$id: http://localhost:3000/schemas/zof/state-transition/1.0.0
version: 1.0.0
title: ZOF State Transition Schema
description: Canonical schema for ZOF state transitions in Matrix Protocol
type: object
required:
  - schema
  - transition_id
  - workflow_ref
  - from_state
  - to_state
  - condition
  - signals
  - metadata
properties:
  schema:
    type: string
    description: Schema version ZOF State Transition used
    pattern: ^[0-9]+\.[0-9]+$
    examples:
      - "1.0"
      - "1.1"
  transition_id:
    type: string
    description: Unique identifier of the transition
    pattern: ^zof-tr-[a-z0-9-]+-[0-9]+$
    examples:
      - zof-tr-auth-flow-001
      - zof-tr-request-workflow-005
  workflow_ref:
    type: string
    description: Reference to workflow ZOF
    pattern: ^zof-[a-z0-9-]+$
    examples:
      - zof-request-flow
      - zof-auth-jwt-implementation
  from_state:
    type: string
    description: Source state of the transition
    enum:
      - intake
      - understand
      - decide
      - act
      - evaluate_for_enrich
      - review
      - enrich
      - complete
      - failed
    examples:
      - intake
      - understand
  to_state:
    type: string
    description: Target state of the transition
    enum:
      - intake
      - understand
      - decide
      - act
      - evaluate_for_enrich
      - review
      - enrich
      - complete
      - failed
    examples:
      - understand
      - decide
  condition:
    type: object
    description: Conditions for transition execution
    required:
      - type
      - expression
      - description
    properties:
      type:
        type: string
        description: Type of transition condition
        enum:
          - completion_criteria
          - oracle_consultation
          - decision_made
          - action_executed
          - evaluation_completed
          - review_approved
          - enrichment_completed
          - timeout
          - error
          - manual_trigger
        examples:
          - completion_criteria
          - oracle_consultation
      expression:
        type: string
        description: Logical expression of the condition
        minLength: 10
        examples:
          - all_completion_criteria_met && context_captured
          - oracle_consulted && knowledge_retrieved
      description:
        type: string
        description: Human-readable description of the condition
        minLength: 20
        examples:
          - All completion criteria have been met and context captured
      parameters:
        type: object
        description: Condition-specific parameters
        properties:
          timeout_ms:
            type: integer
            description: Timeout for condition (if applicable)
            minimum: 1000
            maximum: 600000
          retry_count:
            type: integer
            description: Number of retry attempts (if applicable)
            minimum: 0
            maximum: 10
          threshold_value:
            type: number
            description: Threshold value for approval
            minimum: 0
            maximum: 1
          required_approvals:
            type: integer
            description: Number of required approvals
            minimum: 1
        additionalProperties: true
    additionalProperties: false
  signals:
    type: object
    description: Mandatory explainability signals of the transition
    required:
      - context
      - decision
      - result
    properties:
      context:
        type: string
        description: Context that triggered the transition
        minLength: 30
        examples:
          - Intake state completed with documented requirements and understood context
      decision:
        type: string
        description: Decision that caused the transition
        minLength: 30
        examples:
          - Completion criteria met, proceeding to mandatory Oracle consultation
      result:
        type: string
        description: Result of the transition
        minLength: 30
        examples:
          - Transition to understand state confirmed, Oracle will be consulted
      additional_context:
        type: object
        description: Transition-specific additional context
        properties:
          user_input:
            type: string
            description: Related user input
          system_state:
            type: string
            description: System state at the time of transition
          external_factors:
            type: array
            description: External factors that influenced the transition
            items:
              type: string
          data_artifacts:
            type: array
            description: Data artifacts generated/consumed
            items:
              type: string
        additionalProperties: true
    additionalProperties: false
  validations:
    type: array
    description: Validations executed during the transition
    items:
      type: object
      required:
        - validation_type
        - description
        - status
      properties:
        validation_type:
          type: string
          description: Type of validation
          enum:
            - state_completeness
            - oracle_consultation_required
            - authority_validation
            - moc_criteria_check
            - conflict_detection
            - data_integrity
            - business_rules
            - security_check
          examples:
            - state_completeness
            - authority_validation
        description:
          type: string
          description: Description of the validation
          minLength: 20
          examples:
            - Intake state completeness validation
        status:
          type: string
          description: Validation status
          enum:
            - passed
            - failed
            - warning
            - skipped
          examples:
            - passed
            - failed
        details:
          type: string
          description: Details of the validation result
          examples:
            - All required fields filled
        error_message:
          type: string
          description: Error message (if status=failed)
        remediation_action:
          type: string
          description: Recommended remediation action
      additionalProperties: false
  actions:
    type: array
    description: Actions executed during the transition
    items:
      type: object
      required:
        - action_type
        - description
        - execution_order
      properties:
        action_type:
          type: string
          description: Type of action executed
          enum:
            - oracle_consultation
            - moc_criteria_evaluation
            - authority_validation
            - conflict_detection
            - state_cleanup
            - data_persistence
            - notification
            - logging
            - metrics_collection
            - mal_invocation
          examples:
            - oracle_consultation
            - moc_criteria_evaluation
        description:
          type: string
          description: Description of the action
          minLength: 20
          examples:
            - Consult Oracle for relevant existing knowledge
        execution_order:
          type: integer
          description: Action execution order
          minimum: 1
          examples:
            - 1
            - 2
            - 3
        parameters:
          type: object
          description: Action-specific parameters
          additionalProperties: true
        result:
          type: object
          description: Result of action execution
          properties:
            status:
              type: string
              enum:
                - success
                - failure
                - partial
                - skipped
            output:
              type: string
              description: Output produced by the action
            duration_ms:
              type: integer
              description: Execution duration in milliseconds
              minimum: 0
            error_details:
              type: string
              description: Error details (if status=failure)
          additionalProperties: true
      additionalProperties: false
  transition_config:
    type: object
    description: Transition-specific configurations
    properties:
      auto_execute:
        type: boolean
        description: Execute transition automatically when conditions are met
        default: true
      require_manual_approval:
        type: boolean
        description: Requires manual approval for execution
        default: false
      timeout_ms:
        type: integer
        description: Timeout for transition execution
        minimum: 1000
        maximum: 600000
        default: 30000
      retry_policy:
        type: object
        description: Retry policy in case of failure
        properties:
          max_retries:
            type: integer
            minimum: 0
            maximum: 10
            default: 3
          backoff_strategy:
            type: string
            enum:
              - linear
              - exponential
              - fixed
            default: exponential
          backoff_interval_ms:
            type: integer
            minimum: 100
            maximum: 60000
            default: 1000
        additionalProperties: false
      notification_config:
        type: object
        description: Notification configuration
        properties:
          notify_on_success:
            type: boolean
            default: false
          notify_on_failure:
            type: boolean
            default: true
          notification_channels:
            type: array
            items:
              type: string
            examples:
              - - email
                - slack
                - webhook
        additionalProperties: false
    additionalProperties: false
  mal_integration:
    type: object
    description: MAL integration configuration (when applicable)
    properties:
      conflict_detection_enabled:
        type: boolean
        description: Enable H1/H2/H3 conflict detection
        default: true
      auto_invoke_mal:
        type: boolean
        description: Automatically invoke MAL on conflicts
        default: true
      arbitration_timeout_ms:
        type: integer
        description: Timeout for MAL arbitration
        minimum: 1000
        maximum: 600000
        default: 2000
      fallback_action:
        type: string
        description: Action in case of arbitration failure
        enum:
          - block
          - defer
          - escalate
          - default_safe
        default: default_safe
      decision_record_ref:
        type: string
        description: Reference to MAL Decision Record (if applicable)
        pattern: ^mal-dec-[0-9]{8}-[a-z0-9]+-[0-9]+$
    additionalProperties: false
  metadata:
    type: object
    description: Transition metadata
    required:
      - created_date
      - execution_timestamp
    properties:
      created_date:
        type: string
        format: date
        description: Creation date of the transition definition
      execution_timestamp:
        type: string
        format: date-time
        description: Transition execution timestamp
        examples:
          - 2025-10-31T14:30:25.123Z
      executor:
        type: string
        description: Entity that executed the transition
        examples:
          - workflow-agent
          - user:developer
          - system:automated
      execution_context:
        type: object
        description: Execution context
        properties:
          user_id:
            type: string
            description: ID of the user who initiated the workflow
          session_id:
            type: string
            description: Execution session ID
          environment:
            type: string
            description: Execution environment
            enum:
              - development
              - staging
              - production
          version:
            type: string
            description: ZOF system version
        additionalProperties: true
      duration_ms:
        type: integer
        description: Total transition duration in milliseconds
        minimum: 0
      performance_metrics:
        type: object
        description: Transition performance metrics
        properties:
          cpu_usage:
            type: number
            description: CPU usage during execution
          memory_usage:
            type: number
            description: Memory usage during execution
          network_calls:
            type: integer
            description: Number of network calls
          database_queries:
            type: integer
            description: Number of database queries
        additionalProperties: true
    additionalProperties: false
additionalProperties: false
allOf:
  - if:
      properties:
        from_state:
          const: intake
    then:
      properties:
        to_state:
          enum:
            - understand
            - failed
  - if:
      properties:
        from_state:
          const: understand
    then:
      properties:
        to_state:
          enum:
            - decide
            - failed
  - if:
      properties:
        from_state:
          const: decide
    then:
      properties:
        to_state:
          enum:
            - act
            - failed
  - if:
      properties:
        from_state:
          const: act
    then:
      properties:
        to_state:
          enum:
            - evaluate_for_enrich
            - failed
  - if:
      properties:
        from_state:
          const: evaluate_for_enrich
    then:
      properties:
        to_state:
          enum:
            - review
            - enrich
            - failed
  - if:
      properties:
        from_state:
          const: review
    then:
      properties:
        to_state:
          enum:
            - enrich
            - complete
            - failed
  - if:
      properties:
        from_state:
          const: enrich
    then:
      properties:
        to_state:
          enum:
            - complete
            - failed
