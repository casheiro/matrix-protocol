# MEF Decision Record Schema v1.0.0
# Matrix Embedding Framework - Decision Records for MAL integration
# Normative canonical specification for arbitration decision persistence

$schema: https://json-schema.org/draft/2020-12/schema
$id: http://localhost:3000/schemas/mef/decision-record/1.0.0
version: 1.0.0
title: MEF Decision Record Schema
description: Canonical schema for MAL Decision Records persistence in MEF
type: object
required:
  - schema
  - decision_id
  - event_ref
  - outcome
  - precedence_applied
  - epistemic_rationale
  - audit
  - mef_metadata
properties:
  schema:
    type: string
    description: MEF Decision Record schema version used
    pattern: ^[0-9]+\.[0-9]+$
    examples:
      - "1.0"
      - "1.1"
  decision_id:
    type: string
    description: Unique MAL decision identifier
    pattern: ^mal-dec-[0-9]{8}-[a-z0-9]+-[0-9]+$
    examples:
      - mal-dec-20250826-h1-001
      - mal-dec-20250827-h2-042
  event_ref:
    type: string
    description: Reference to originating arbitration event
    pattern: ^mal-evt-[0-9]{8}-[0-9]+$
    examples:
      - mal-evt-20250826-001
      - mal-evt-20250827-042
  outcome:
    type: string
    description: MAL arbitration result
    enum:
      - winner
      - coexist
      - reject_all
      - defer
    examples:
      - winner
      - coexist
  winner:
    type: string
    description: UKI chosen as authoritative (required if outcome=winner)
    pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
    examples:
      - uki:squad-x:rule:data-retention-30d
  losers:
    type: array
    description: UKIs defeated in arbitration
    items:
      type: string
      pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
    examples:
      - - uki:squad-x:rule:data-retention-7d
  precedence_applied:
    type: array
    description: Precedence rules applied in decision
    minItems: 1
    items:
      type: object
      required:
        - rule
        - description
        - impact
      properties:
        rule:
          type: string
          description: Precedence rule identifier
          pattern: ^P[0-9]+_[a-z_]+$
          examples:
            - P1_authority_weight
            - P3_maturity_level
        description:
          type: string
          description: Human-readable rule explanation
          minLength: 20
          examples:
            - validated > endorsed
            - Higher authority weight
        impact:
          type: string
          description: How this rule affected the decision
          minLength: 20
          examples:
            - Determined winner by superior maturity
        weight:
          type: number
          description: Numerical rule weight (optional)
          minimum: 0
          maximum: 1
      additionalProperties: false
  epistemic_rationale:
    type: object
    description: Epistemic explanation aligned with MEP principles
    required:
      - summary
      - reasoning
      - references
    properties:
      summary:
        type: string
        description: Brief decision justification
        minLength: 50
        maxLength: 500
        examples:
          - Validated maturity and stronger regulatory evidence determined the choice
      reasoning:
        type: string
        description: Detailed explanation of epistemic reasoning
        minLength: 100
        examples:
          - While both UKIs operate in equivalent scope, the 30-day retention rule...
      references:
        type: object
        description: References used in decision
        required:
          - moc_nodes
          - mef_evidence
        properties:
          moc_nodes:
            type: array
            description: Referenced MOC nodes
            items:
              type: string
              pattern: ^[a-z0-9.-]+$
            examples:
              - - hierarchies.scope.squad-x
                - hierarchies.domain.security
          mef_evidence:
            type: array
            description: Referenced MEF evidence
            items:
              type: string
              pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
            examples:
              - - uki:org:policy:lgpd-compliance
          external_references:
            type: array
            description: External references (documents, regulations)
            items:
              type: string
            examples:
              - - doc:audit-logs-2024
                - reg:lgpd-art-6
        additionalProperties: false
    additionalProperties: false
  audit:
    type: object
    description: Mandatory audit information
    required:
      - decided_at
      - decided_by
      - timeout_used_ms
    properties:
      decided_at:
        type: string
        format: date-time
        description: Precise decision timestamp
        examples:
          - 2025-08-26T14:30:25.123Z
      decided_by:
        type: string
        description: MAL version identifier that made the decision
        pattern: ^mal-v[0-9]+\.[0-9]+\.[0-9]+$
        examples:
          - mal-v1.0.0
          - mal-v1.2.3
      timeout_used_ms:
        type: integer
        description: Processing time used in milliseconds
        minimum: 0
        maximum: 600000
        examples:
          - 1250
          - 5000
      arbitration_timeout_ms:
        type: integer
        description: Timeout configured for arbitration
        minimum: 1000
        maximum: 600000
        examples:
          - 2000
          - 10000
    additionalProperties: false
  mef_metadata:
    type: object
    description: Specific metadata for MEF persistence
    required:
      - persistence_id
      - persistence_date
      - immutable
    properties:
      persistence_id:
        type: string
        description: Unique persistence identifier in MEF
        pattern: ^mef-dr-[0-9]{8}-[a-z0-9]{8}$
        examples:
          - mef-dr-20250826-a1b2c3d4
      persistence_date:
        type: string
        format: date-time
        description: MEF persistence timestamp
        examples:
          - 2025-08-26T14:30:26.789Z
      immutable:
        type: boolean
        description: Flag indicating record immutability
        const: true
      checksum:
        type: string
        description: Checksum for integrity verification
        pattern: ^[a-f0-9]{64}$
        examples:
          - a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456
      retention_policy:
        type: string
        description: Record retention policy
        enum:
          - permanent
          - regulatory
          - operational
        default: permanent
    additionalProperties: false
  conflict_details:
    type: object
    description: Specific details of the arbitrated conflict
    required:
      - event_type
      - candidates
    properties:
      event_type:
        type: string
        description: Arbitrated conflict type
        enum:
          - H1
          - H2
          - H3
        examples:
          - H1
          - H2
      conflict_description:
        type: string
        description: Textual description of the conflict
        minLength: 50
        examples:
          - Two security rules of equivalent scope in conflict
      candidates:
        type: array
        description: Candidate UKIs that were arbitrated
        minItems: 2
        items:
          type: object
          required:
            - uki_ref
            - scope_ref
            - domain_ref
            - maturity_level
          properties:
            uki_ref:
              type: string
              pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
            scope_ref:
              type: string
            domain_ref:
              type: string
            maturity_level:
              type: string
            version:
              type: string
              pattern: ^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)$
            evidence_refs:
              type: array
              items:
                type: string
          additionalProperties: false
    additionalProperties: false
  actions:
    type: array
    description: Actions to be executed based on the decision
    items:
      type: string
      pattern: "^(allow_enrich|defer_enrich|gate_enrich|deprecate|partition_scope):"
      examples:
        - allow_enrich:zof-auth-jwt-implementation-002
        - deprecate:uki:squad-x:rule:data-retention-7d
  organizational_context:
    type: object
    description: Organizational context of the decision
    properties:
      user_authority:
        type: string
        description: Authority level of the requesting user
        examples:
          - squad_lead
          - tech_lead
      user_scopes:
        type: array
        description: User accessible scopes
        items:
          type: string
        examples:
          - - squad-x
            - tribe-alpha
      operation:
        type: string
        description: Operation that triggered arbitration
        enum:
          - read
          - enrich
          - promote
        examples:
          - enrich
      policy_ref:
        type: string
        description: MOC arbitration policy used
        pattern: ^moc:arbitration:[a-z0-9-_]+$
        examples:
          - moc:arbitration:security_priority
    additionalProperties: false
additionalProperties: false
allOf:
  - if:
      properties:
        outcome:
          const: winner
    then:
      required:
        - winner
  - if:
      properties:
        outcome:
          enum:
            - coexist
            - reject_all
    then:
      properties:
        actions:
          minItems: 1
  - if:
      properties:
        conflict_details:
          properties:
            event_type:
              const: H1
    then:
      properties:
        conflict_details:
          properties:
            candidates:
              minItems: 2
              items:
                required:
                  - uki_ref
                  - scope_ref
                  - domain_ref
