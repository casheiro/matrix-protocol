# MAL Decision Record Schema v1.0.0
# Matrix Arbiter Layer - Registros de Decisão
# Especificação canônica normativa para registros de decisão de arbitragem

$schema: https://json-schema.org/draft/2020-12/schema
$id: http://localhost:3000/schemas/mal/decision-record/1.0.0
version: 1.0.0
title: MAL Decision Record Schema
description: Schema canônico para registros de decisão MAL no Matrix Protocol
type: object
required:
  - schema
  - decision_id
  - event_ref
  - outcome
  - precedence_applied
  - epistemic_rationale
  - audit
properties:
  schema:
    type: string
    description: Versão do schema MAL Decision Record utilizado
    pattern: ^[0-9]+\.[0-9]+$
    examples:
      - "1.0"
      - "1.1"
  decision_id:
    type: string
    description: Identificador único da decisão MAL
    pattern: ^mal-dec-[0-9]{8}-[a-z0-9]+-[0-9]+$
    examples:
      - mal-dec-20250826-h1-001
      - mal-dec-20250827-h2-042
  event_ref:
    type: string
    description: Referência ao evento de arbitragem originário
    pattern: ^mal-evt-[0-9]{8}-[0-9]+$
    examples:
      - mal-evt-20250826-001
      - mal-evt-20250827-042
  outcome:
    type: string
    description: Resultado da decisão de arbitragem
    enum:
      - winner
      - coexist
      - reject_all
      - defer
    examples:
      - winner
      - coexist
  winner:
    type: string
    description: UKI escolhida como autoritativa (obrigatório se outcome=winner)
    pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
    examples:
      - uki:squad-x:rule:retencao-dados-30d
  losers:
    type: array
    description: UKIs derrotadas na arbitragem
    items:
      type: string
      pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
    examples:
      - - uki:squad-x:rule:retencao-dados-7d
  coexistence_arrangement:
    type: object
    description: Arranjo de coexistência (obrigatório se outcome=coexist)
    properties:
      partition_strategy:
        type: string
        description: Estratégia de particionamento aplicada
        enum:
          - scope_partition
          - domain_partition
          - temporal_partition
          - conditional_partition
        examples:
          - scope_partition
      partition_rules:
        type: array
        description: Regras específicas de particionamento
        items:
          type: object
          required:
            - uki_ref
            - assigned_context
            - conditions
          properties:
            uki_ref:
              type: string
              pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
              description: UKI sendo particionada
            assigned_context:
              type: object
              description: Contexto atribuído à UKI
              properties:
                scope_restriction:
                  type: string
                  description: Restrição de escopo
                domain_restriction:
                  type: string
                  description: Restrição de domínio
                temporal_restriction:
                  type: string
                  description: Restrição temporal
                conditional_rules:
                  type: array
                  description: Regras condicionais
                  items:
                    type: string
              additionalProperties: false
            conditions:
              type: array
              description: Condições para aplicação
              items:
                type: string
              examples:
                - - user.scope == 'squad-x'
                  - operation == 'read'
            precedence_order:
              type: integer
              description: Ordem de precedência (1 = mais alta)
              minimum: 1
          additionalProperties: false
      conflict_resolution_rules:
        type: array
        description: Regras para resolução de conflitos futuros
        items:
          type: string
        examples:
          - Em caso de sobreposição, squad-x tem precedência sobre squad-y
    additionalProperties: false
  rejection_rationale:
    type: object
    description: Justificativa de rejeição (obrigatório se outcome=reject_all)
    properties:
      primary_reason:
        type: string
        description: Razão principal para rejeição
        enum:
          - insufficient_evidence
          - policy_violation
          - authority_conflict
          - semantic_inconsistency
          - quality_standards_not_met
          - organizational_conflict
        examples:
          - insufficient_evidence
          - quality_standards_not_met
      detailed_analysis:
        type: string
        description: Análise detalhada da rejeição
        minLength: 100
        examples:
          - Nenhuma das UKIs candidatas atende aos critérios mínimos de evidência estabelecidos no MOC organizacional
      improvement_recommendations:
        type: array
        description: Recomendações para melhoria
        items:
          type: string
        examples:
          - Adicionar evidências de conformidade regulatória
          - Obter aprovação de autoridade competente
      alternative_paths:
        type: array
        description: Caminhos alternativos sugeridos
        items:
          type: string
        examples:
          - Criar nova UKI com evidências adequadas
          - Escalação para autoridade superior
    additionalProperties: false
  deferral_details:
    type: object
    description: Detalhes de adiamento (obrigatório se outcome=defer)
    properties:
      deferral_reason:
        type: string
        description: Razão para adiamento
        enum:
          - insufficient_context
          - policy_ambiguity
          - human_judgment_required
          - external_dependency
          - conflicting_authorities
          - system_limitations
        examples:
          - human_judgment_required
          - policy_ambiguity
      required_actions:
        type: array
        description: Ações necessárias antes da re-arbitragem
        items:
          type: object
          required:
            - action_type
            - description
            - responsible_party
          properties:
            action_type:
              type: string
              enum:
                - human_review
                - policy_clarification
                - evidence_collection
                - authority_escalation
            description:
              type: string
              minLength: 30
            responsible_party:
              type: string
              description: Parte responsável pela ação
            deadline:
              type: string
              format: date-time
              description: Prazo para conclusão
          additionalProperties: false
      re_arbitration_conditions:
        type: array
        description: Condições para nova arbitragem
        items:
          type: string
        examples:
          - Política de precedência clarificada pelo MOC
          - Revisão humana completada
      escalation_contacts:
        type: array
        description: Contatos para escalação
        items:
          type: string
        examples:
          - governance-board
          - technical-lead
    additionalProperties: false
  precedence_applied:
    type: array
    description: Regras de precedência aplicadas na decisão
    minItems: 1
    items:
      type: object
      required:
        - rule_id
        - description
        - weight
        - application_result
      properties:
        rule_id:
          type: string
          description: Identificador da regra de precedência
          pattern: ^P[0-9]+_[a-z_]+$
          examples:
            - P1_authority_weight
            - P3_maturity_level
        description:
          type: string
          description: Descrição da regra aplicada
          minLength: 20
          examples:
            - Maior peso de autoridade hierárquica
            - Conhecimento validado supera experimental
        weight:
          type: number
          description: Peso aplicado à regra (0.0 a 1.0)
          minimum: 0
          maximum: 1
          examples:
            - 0.8
            - 0.6
            - 0.4
        application_result:
          type: object
          description: Resultado da aplicação da regra
          required:
            - rule_outcome
            - impact_on_decision
          properties:
            rule_outcome:
              type: string
              description: Resultado específico da regra
              examples:
                - tech_lead > developer
                - validated > experimental
            impact_on_decision:
              type: string
              description: Como impactou a decisão final
              enum:
                - decisive
                - supportive
                - neutral
                - contradictory
              examples:
                - decisive
                - supportive
            numerical_score:
              type: number
              description: Pontuação numérica (se aplicável)
              minimum: 0
              maximum: 1
            compared_entities:
              type: array
              description: Entidades comparadas por esta regra
              items:
                type: object
                required:
                  - entity_ref
                  - entity_value
                  - score
                properties:
                  entity_ref:
                    type: string
                    pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
                  entity_value:
                    type: string
                    description: Valor da entidade para esta regra
                  score:
                    type: number
                    minimum: 0
                    maximum: 1
                additionalProperties: false
          additionalProperties: false
        policy_source:
          type: string
          description: Fonte da política que define esta regra
          examples:
            - moc:arbitration:default
            - protocol_canonical
        custom_parameters:
          type: object
          description: Parâmetros customizados da regra
          additionalProperties: true
      additionalProperties: false
  epistemic_rationale:
    type: object
    description: Explicação epistêmica alinhada aos princípios MEP
    required:
      - summary
      - reasoning
      - references
    properties:
      summary:
        type: string
        description: Justificativa breve da decisão
        minLength: 50
        maxLength: 500
        examples:
          - Maturidade validada e evidência regulatória mais forte determinaram a escolha da regra de 30 dias
      reasoning:
        type: string
        description: Explicação detalhada do raciocínio epistêmico
        minLength: 100
        examples:
          - Enquanto ambas as UKIs operam em escopo equivalente de squad, a regra de retenção de 30 dias demonstra maior
            maturidade epistemológica através de seu status 'validated' e evidência regulatória mais robusta ligada aos
            requisitos de conformidade LGPD
      references:
        type: object
        description: Referências utilizadas na decisão
        required:
          - moc_nodes
          - mef_evidence
        properties:
          moc_nodes:
            type: array
            description: Nós MOC referenciados
            items:
              type: string
              pattern: ^[a-z0-9.-]+$
            examples:
              - - hierarchies.scope.squad-x
                - hierarchies.domain.security
          mef_evidence:
            type: array
            description: Evidências MEF referenciadas
            items:
              type: string
              pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
            examples:
              - - uki:org:policy:lgpd-compliance
          external_references:
            type: array
            description: Referências externas (documentos, regulamentações)
            items:
              type: string
            examples:
              - - doc:logs-auditoria-2024
                - reg:lgpd-art-6
          policy_references:
            type: array
            description: Referências de política utilizadas
            items:
              type: string
              pattern: ^moc:arbitration:[a-z0-9_-]+$
            examples:
              - - moc:arbitration:security_priority
        additionalProperties: false
      mep_alignment:
        type: object
        description: Alinhamento com princípios MEP
        properties:
          epistemic_humility:
            type: string
            description: Como demonstra humildade epistêmica
            examples:
              - Decisão baseada em critérios específicos organizacionais, reconhecendo limitações contextuais
          derived_authority:
            type: string
            description: Como respeita autoridade derivada
            examples:
              - Autoridade deriva do MOC organizacional e configuração de políticas
          contextual_knowledge:
            type: string
            description: Como reconhece conhecimento contextual
            examples:
              - Decisão específica para contexto squad-x no domínio segurança
          responsible_promotion:
            type: string
            description: Como pratica promoção responsável
            examples:
              - Baseada em evidência adequada e validação por autoridade competente
          explanatory_coherence:
            type: string
            description: Como mantém coerência explicativa
            examples:
              - Decisão consistente com precedentes e políticas organizacionais
        additionalProperties: false
      uncertainty_assessment:
        type: object
        description: Avaliação de incertezas
        properties:
          confidence_level:
            type: number
            description: Nível de confiança na decisão (0.0 a 1.0)
            minimum: 0
            maximum: 1
            examples:
              - 0.85
              - 0.92
          risk_factors:
            type: array
            description: Fatores de risco identificados
            items:
              type: string
            examples:
              - Evidência regulatória pode mudar
              - Contexto organizacional em evolução
          sensitivity_analysis:
            type: string
            description: Análise de sensibilidade da decisão
            examples:
              - Decisão robusta a pequenas variações nos critérios
          alternative_scenarios:
            type: array
            description: Cenários alternativos considerados
            items:
              type: string
            examples:
              - Se evidência adicional emergir, reavaliação pode ser necessária
        additionalProperties: false
    additionalProperties: false
  actions:
    type: array
    description: Ações a serem executadas baseadas na decisão
    items:
      type: string
      pattern: "^(allow_enrich|defer_enrich|gate_enrich|deprecate|partition_scope|promote|escalate):"
      examples:
        - allow_enrich:zof-auth-jwt-implementation-002
        - deprecate:uki:squad-x:rule:retencao-dados-7d
        - partition_scope:squad-x:read_only
  audit:
    type: object
    description: Informações de auditoria obrigatórias
    required:
      - decided_at
      - decided_by
      - timeout_used_ms
    properties:
      decided_at:
        type: string
        format: date-time
        description: Timestamp preciso da decisão
        examples:
          - 2025-08-26T14:30:25.123Z
      decided_by:
        type: string
        description: Identificador da versão MAL que tomou a decisão
        pattern: ^mal-v[0-9]+\.[0-9]+\.[0-9]+$
        examples:
          - mal-v1.0.0
          - mal-v1.2.3
      timeout_used_ms:
        type: integer
        description: Tempo de processamento usado em milissegundos
        minimum: 0
        maximum: 600000
        examples:
          - 1250
          - 5000
      arbitration_timeout_ms:
        type: integer
        description: Timeout configurado para arbitragem
        minimum: 1000
        maximum: 600000
        examples:
          - 2000
          - 10000
      processing_details:
        type: object
        description: Detalhes de processamento
        properties:
          algorithm_version:
            type: string
            description: Versão do algoritmo de arbitragem
            examples:
              - precedence-v1.0
              - weighted-v2.1
          policy_config_version:
            type: string
            description: Versão da configuração de política
            examples:
              - moc-policy-v1.2
          computational_complexity:
            type: string
            description: Complexidade computacional da decisão
            enum:
              - low
              - medium
              - high
              - very_high
          memory_usage_mb:
            type: number
            description: Uso de memória durante processamento
            minimum: 0
          database_queries:
            type: integer
            description: Número de consultas ao banco
            minimum: 0
        additionalProperties: true
      quality_indicators:
        type: object
        description: Indicadores de qualidade da decisão
        properties:
          consistency_check:
            type: boolean
            description: Verificação de consistência passou
          precedent_alignment:
            type: number
            description: Alinhamento com precedentes (0.0 a 1.0)
            minimum: 0
            maximum: 1
          stakeholder_impact_assessment:
            type: string
            description: Avaliação de impacto nos stakeholders
            enum:
              - minimal
              - moderate
              - significant
              - major
        additionalProperties: false
    additionalProperties: false
  communication_metadata:
    type: object
    description: Metadados para comunicação da decisão
    properties:
      notification_required:
        type: boolean
        description: Notificação é necessária
        default: true
      notification_targets:
        type: array
        description: Alvos de notificação
        items:
          type: string
        examples:
          - original_requester
          - affected_stakeholders
          - governance_board
      explanation_template_ref:
        type: string
        description: Referência ao template de explicação
        pattern: ^oif-exp-template-[a-z0-9-]+$
        examples:
          - oif-exp-template-standard
          - oif-exp-template-technical
      urgency_level:
        type: string
        description: Nível de urgência da comunicação
        enum:
          - low
          - normal
          - high
          - urgent
        default: normal
    additionalProperties: false
additionalProperties: false
allOf:
  - if:
      properties:
        outcome:
          const: winner
    then:
      required:
        - winner
  - if:
      properties:
        outcome:
          const: coexist
    then:
      required:
        - coexistence_arrangement
  - if:
      properties:
        outcome:
          const: reject_all
    then:
      required:
        - rejection_rationale
  - if:
      properties:
        outcome:
          const: defer
    then:
      required:
        - deferral_details
  - properties:
      precedence_applied:
        minItems: 1
