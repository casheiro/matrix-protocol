# OIF Arbitration Explanation Schema v1.0.0
# Operator Intelligence Framework - Arbitration Explanation Templates
# Normative canonical specification for MAL decision explanations

$schema: https://json-schema.org/draft/2020-12/schema
$id: http://localhost:3000/schemas/oif/arbitration-explanation/1.0.0
version: 1.0.0
title: OIF Arbitration Explanation Schema
description: Canonical schema for MAL arbitration explanation templates in OIF
type: object
required:
  - schema
  - explanation_id
  - decision_id
  - event_type
  - outcome
  - summary
  - reason_code
  - precedence_explanation
  - moc_references
  - next_steps
  - metadata
properties:
  schema:
    type: string
    description: Schema version OIF Arbitration Explanation used
    pattern: ^[0-9]+\.[0-9]+$
    examples:
      - "1.0"
      - "1.1"
  explanation_id:
    type: string
    description: Unique identifier of the explanation
    pattern: ^oif-exp-[0-9]{8}-[a-z0-9]+-[0-9]+$
    examples:
      - oif-exp-20250826-h1-001
      - oif-exp-20250827-h2-042
  decision_id:
    type: string
    description: Identifier of the MAL decision being explained
    pattern: ^mal-dec-[0-9]{8}-[a-z0-9]+-[0-9]+$
    examples:
      - mal-dec-20250826-h1-001
  event_type:
    type: string
    description: Arbitrated conflict type
    enum:
      - H1
      - H2
      - H3
    examples:
      - H1
      - H2
  outcome:
    type: string
    description: Arbitration result MAL
    enum:
      - winner
      - coexist
      - reject_all
      - defer
    examples:
      - winner
      - coexist
  summary:
    type: string
    description: User-friendly explanation of the result
    minLength: 50
    maxLength: 500
    examples:
      - The 30-day data retention rule was chosen as winner due to higher epistemological maturity and stronger
        regulatory evidence
  reason_code:
    type: string
    description: Structured reason identifier
    pattern: ^[A-Z0-9_]+$
    examples:
      - MATURITY_AND_EVIDENCE_PRECEDENCE
      - AUTHORITY_HIERARCHY_DECISIVE
      - TEMPORAL_PRECEDENCE_APPLIED
  winner:
    type: string
    description: UKI chosen as authoritative (required if outcome=winner)
    pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
    examples:
      - uki:squad-x:rule:data-retention-30d
  losers:
    type: array
    description: UKIs defeated in arbitration (required if outcome=winner)
    items:
      type: string
      pattern: ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$
    examples:
      - - uki:squad-x:rule:data-retention-7d
  coexistence_details:
    type: object
    description: Coexistence details (required if outcome=coexist)
    properties:
      partition_strategy:
        type: string
        description: Partitioning strategy applied
        enum:
          - scope_partition
          - domain_partition
          - temporal_partition
        examples:
          - scope_partition
      partition_assignments:
        type: object
        description: Partition assignments
        patternProperties:
          ^uki:[a-z0-9-]+:[a-z0-9_]+:[a-z0-9-]+$:
            type: object
            required:
              - assigned_scope
              - reason
            properties:
              assigned_scope:
                type: string
                description: Scope assigned to the UKI
              reason:
                type: string
                description: Reason for assignment
            additionalProperties: false
        additionalProperties: false
      coexistence_rationale:
        type: string
        description: Rationale for coexistence
        minLength: 50
    additionalProperties: false
  rejection_details:
    type: object
    description: Rejection details (required if outcome=reject_all)
    properties:
      rejection_reason:
        type: string
        description: Reason for rejecting all UKIs
        examples:
          - No UKI meets minimum quality criteria
      alternative_actions:
        type: array
        description: Recommended alternative actions
        items:
          type: string
        examples:
          - - Create new UKI with adequate evidence
            - Seek approval from higher authority
    additionalProperties: false
  deferral_details:
    type: object
    description: Deferral details (required if outcome=defer)
    properties:
      deferral_reason:
        type: string
        description: Reason for decision deferral
        examples:
          - Requires human oversight due to conflict complexity
      required_intervention:
        type: string
        description: Type of intervention required
        enum:
          - human_oversight
          - additional_evidence
          - policy_clarification
          - authority_escalation
      intervention_contacts:
        type: array
        description: Contacts for intervention
        items:
          type: string
        examples:
          - - governance-board
            - technical-lead
            - compliance-officer
    additionalProperties: false
  precedence_explanation:
    type: array
    description: Precedence rules applied in the decision
    minItems: 1
    items:
      type: object
      required:
        - rule
        - description
        - impact
      properties:
        rule:
          type: string
          description: Precedence rule identifier
          pattern: ^P[0-9]+_[a-z_]+$
          examples:
            - P1_authority_weight
            - P3_maturity_level
        description:
          type: string
          description: Human-readable explanation of the rule
          minLength: 20
          examples:
            - Higher hierarchical authority weight wins
            - Validated knowledge takes precedence over experimental
        impact:
          type: string
          description: How this rule affected the specific decision
          minLength: 30
          examples:
            - Determined that squad-lead has higher authority than developer in this context
        weight_applied:
          type: number
          description: Numerical weight applied to the rule (0.0 to 1.0)
          minimum: 0
          maximum: 1
          examples:
            - 0.8
            - 0.6
        decisive_factor:
          type: boolean
          description: This rule was the decisive factor
          examples:
            - true
            - false
      additionalProperties: false
  moc_references:
    type: array
    description: MOC authority nodes referenced in the decision
    minItems: 1
    items:
      type: object
      required:
        - node_id
        - node_type
        - relevance
      properties:
        node_id:
          type: string
          description: MOC node identifier
          pattern: ^[a-z0-9.-]+$
          examples:
            - hierarchies.scope.squad-x
            - hierarchies.domain.security
            - hierarchies.authority.tech_lead
        node_type:
          type: string
          description: MOC node type
          enum:
            - scope
            - domain
            - authority
            - policy
            - criteria
          examples:
            - scope
            - authority
        relevance:
          type: string
          description: Why this node was relevant to the decision
          minLength: 30
          examples:
            - Defines the scope where both UKIs operate
            - Establishes the applicable authority hierarchy
        node_value:
          type: string
          description: Specific node value used in the decision
          examples:
            - squad-x
            - tech_lead
            - validated
        decision_influence:
          type: string
          description: How this node influenced the decision
          enum:
            - supportive
            - decisive
            - contextual
            - restrictive
          examples:
            - decisive
            - supportive
      additionalProperties: false
  next_steps:
    type: string
    description: Recommended actions for the user after the decision
    minLength: 50
    examples:
      - Use the approved 30-day retention rule. For future data policies, consult the winning UKI as reference.
  escalation_path:
    type: string
    description: Available escalation options (optional)
    examples:
      - To question this decision, contact the tech-lead responsible for the security domain
  epistemic_context:
    type: object
    description: Epistemic context of the explanation aligned with MEP
    required:
      - humility_demonstration
      - authority_acknowledgment
      - contextual_awareness
    properties:
      humility_demonstration:
        type: string
        description: How the explanation demonstrates epistemic humility
        examples:
          - The decision is based on specific organizational criteria and may vary in other contexts
      authority_acknowledgment:
        type: string
        description: How it acknowledges derived authority
        examples:
          - The authority for this decision derives from the MOC organizational configuration
      contextual_awareness:
        type: string
        description: How it demonstrates contextual awareness
        examples:
          - This decision applies specifically to squad-x scope in the security domain
      uncertainty_acknowledgment:
        type: string
        description: Acknowledgment of uncertainties (if applicable)
        examples:
          - Some evidence was inconclusive, but the overall weight favored this choice
      learning_opportunity:
        type: string
        description: Learning opportunities identified
        examples:
          - This conflict suggests need for better alignment in retention policies
    additionalProperties: false
  presentation_config:
    type: object
    description: Explanation presentation configuration
    properties:
      target_audience:
        type: string
        description: Target audience for the explanation
        enum:
          - developer
          - tech_lead
          - business_user
          - compliance_officer
          - general
        default: general
      detail_level:
        type: string
        description: Detail level of the explanation
        enum:
          - minimal
          - standard
          - detailed
          - comprehensive
        default: standard
      technical_depth:
        type: string
        description: Appropriate technical depth
        enum:
          - low
          - medium
          - high
        default: medium
      include_examples:
        type: boolean
        description: Include practical examples
        default: true
      highlight_key_points:
        type: boolean
        description: Highlight key points
        default: true
      format_preference:
        type: string
        description: Preferred presentation format
        enum:
          - narrative
          - structured
          - bullet_points
          - conversational
        default: structured
    additionalProperties: false
  feedback_collection:
    type: object
    description: Feedback collection configuration
    properties:
      feedback_enabled:
        type: boolean
        description: Feedback collection enabled
        default: true
      feedback_categories:
        type: array
        description: Available feedback categories
        items:
          type: string
          enum:
            - clarity
            - completeness
            - usefulness
            - accuracy
            - actionability
        default:
          - clarity
          - usefulness
      improvement_tracking:
        type: boolean
        description: Improvement tracking based on feedback
        default: true
    additionalProperties: false
  metadata:
    type: object
    description: Explanation metadata
    required:
      - generated_at
      - generator
      - template_version
    properties:
      generated_at:
        type: string
        format: date-time
        description: Explanation generation timestamp
      generator:
        type: string
        description: Archetype that generated the explanation
        examples:
          - knowledge-agent
          - workflow-agent
          - specialized-agent
      template_version:
        type: string
        description: Template version used
        pattern: ^[0-9]+\.[0-9]+\.[0-9]+$
        examples:
          - 1.0.0
          - 1.2.1
      generation_duration_ms:
        type: integer
        description: Explanation generation time
        minimum: 0
      user_context:
        type: object
        description: Context of the user receiving the explanation
        properties:
          user_id:
            type: string
            description: User ID
          authority_level:
            type: string
            description: User authority level
          domains_accessible:
            type: array
            description: Domains accessible to the user
            items:
              type: string
          preferred_language:
            type: string
            description: Preferred language
            enum:
              - pt
              - en
            default: pt
        additionalProperties: true
      quality_metrics:
        type: object
        description: Explanation quality metrics
        properties:
          clarity_score:
            type: number
            description: Clarity score (0.0 to 1.0)
            minimum: 0
            maximum: 1
          completeness_score:
            type: number
            description: Completeness score (0.0 to 1.0)
            minimum: 0
            maximum: 1
          moc_citation_completeness:
            type: number
            description: MOC citation completeness (0.0 to 1.0)
            minimum: 0
            maximum: 1
        additionalProperties: false
    additionalProperties: false
additionalProperties: false
allOf:
  - if:
      properties:
        outcome:
          const: winner
    then:
      required:
        - winner
        - losers
  - if:
      properties:
        outcome:
          const: coexist
    then:
      required:
        - coexistence_details
  - if:
      properties:
        outcome:
          const: reject_all
    then:
      required:
        - rejection_details
  - if:
      properties:
        outcome:
          const: defer
    then:
      required:
        - deferral_details
  - properties:
      precedence_explanation:
        contains:
          properties:
            decisive_factor:
              const: true
